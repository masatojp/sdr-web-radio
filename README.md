# Web SDR Monitor for rtl_tcp

これは、RTL-SDRドングルを `rtl_tcp` 経由で操作し、ブラウザ上でAM/FMラジオを聴取するためのWebアプリケーションです。

Node.jsをバックエンドとして、リアルタイムのI/Qデータを処理し、Web Audio APIを使用してフロントエンドで再生します。特に、Androidデバイスでのバックグラウンド再生を安定させるための工夫が施されています。


## ✨ 主な機能

-   **WebベースのUI**: モダンなブラウザで動作する、シンプルで直感的なインターフェース。
-   **AM/FM復調**: バックエンドでAMおよび広帯域FMのリアルタイム復調処理を実装。
-   **自動スケルチ**: 信号強度に基づいてノイズを抑制するインテリジェントなスケルチ機能。
-   **Androidバックグラウンド再生対応**: Media Session APIやサイレントオーディオの再生により、スマートフォンの画面がオフになっても再生が途切れにくい設計。
-   **ブックマーク機能**: 周波数、モード、名前を保存・編集できるブックマーク機能。フォルダによる階層管理も可能です。
-   **パスワード保護**: チューニング操作をパスワードで保護。
-   **低遅延**: WebSocketを利用して、リアルタイムに音声データをストリーミング。
-   **設定の永続化**: スケルチの基準値やブックマーク情報をサーバーサイドのJSONファイルに自動保存。

## ⚙️ 必要なもの

-   **Node.js**: v14以降を推奨
-   **RTL-SDRドングル**: (RTL2832Uベースのチューナー)
-   **rtl-sdr**: `rtl_tcp` コマンドが利用できる環境が必要です。

## 🚀 インストールとセットアップ

1.  **リポジトリをクローン**
    ```bash
    git clone https://github.com/masatojp/sdr-web-radio.git
    cd sdr-web-radio
    ```

2.  **依存パッケージをインストール**
    このプロジェクトは `ws` (WebSocketライブラリ) に依存しています。
    ```bash
    npm install ws
    npm install flac-bindings
    ```

3.  **設定ファイルを編集**
    `app.js` の先頭にある `CONFIG` オブジェクトを環境に合わせて編集します。

    ```javascript
    const CONFIG = {
        rtlHost: '127.0.0.1', // rtl_tcpが動作しているホスト
        rtlPort: 1234,        // rtl_tcpがリッスンしているポート
        webPort: 3000,        // このWebアプリを公開するポート
        // 初期設定
        frequency: 93500000,  // 初期周波数 (Hz)
        mode: 'FM',           // 初期モード ('AM' or 'FM')
        // ...
        password: "admin",    // チューニング時に要求されるパスワード
        // ...
    };
    ```

## ▶️ 実行方法

1.  **`rtl_tcp` サーバーを起動**
    ターミナルを開き、RTL-SDRドングルを接続した状態で以下のコマンドを実行します。
    `app.js` の `CONFIG` で設定したホストとポートに合わせてください。

    ```bash
    rtl_tcp -a 127.0.0.1 -p 1234
    ```

2.  **Webアプリケーションを起動**
    別のターミナルを開き、以下のコマンドでNode.jsサーバーを起動します。

    ```bash
    node app.js
    ```
    サーバーが起動すると、コンソールに以下のようなメッセージが表示されます。
    ```
    [System] Starting Web SDR Monitor (Android Background Fix)...
    [Web] Server running at http://0.0.0.0:3000
    [RTL-TCP] Connected.
    ```

3.  **ブラウザでアクセス**
    Webブラウザで `http://<サーバーのIPアドレス>:3000` にアクセスします。（例: `http://localhost:3000`）

## 🛠️ 技術的な詳細

-   **バックエンド (Node.js)**
    -   `http`: WebフロントエンドのHTML/CSS/JSを配信します。
    -   `net`: `rtl_tcp` サーバーにTCPソケットで接続し、I/Qデータを受信します。
    -   `ws`: フロントエンドとの間でWebSocket通信を行い、音声データや制御コマンドを送受信します。
    -   **DSP処理**: 受信したI/Qデータをデシメーションし、AMまたはFM復調、ローパスフィルタ、AGC（自動利得制御）などの信号処理を行います。

-   **フロントエンド (ブラウザ)**
    -   **Web Worker**: WebSocket通信をバックグラウンドのスレッドで処理し、UIのブロッキングを防ぎます。
    -   **Web Audio API**: サーバーから送られてきた音声データをリアルタイムに再生します。バッファ管理により、スムーズな再生を実現します。
    -   **Media Session API**: Androidなどのモバイルデバイスで、OSのメディアコントロール（通知センターやロック画面）に再生情報を表示し、バックグラウンド再生を補助します。
    -   **Keep-Alive Oscillator**: 一部のブラウザ（特にモバイル版Chrome）が完全な無音状態を検知してオーディオコンテキストを停止するのを防ぐため、人間には聞こえない極低周波・低音量の音を常時再生しています。

## 📄 ライセンス

このプロジェクトは MITライセンス の下で公開されています。
